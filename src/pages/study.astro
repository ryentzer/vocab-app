---
import { seedIfEmpty } from '../lib/seed.js';
import { getDueWords, getDueWordsForList, getListById } from '../lib/db.js';
import Flashcard from '../components/Flashcard.astro';
import Nav from '../components/Nav.astro';
import Head from '../components/Head.astro';
import Foot from '../components/Foot.astro';

seedIfEmpty();

const userId = Astro.locals.user!.id;
const url = new URL(Astro.request.url);
const cardIndexParam = url.searchParams.get('card');
const cardIndex = cardIndexParam ? parseInt(cardIndexParam, 10) : 0;

// Session summary mode
const done = url.searchParams.get('done') === '1';
const reviewed = parseInt(url.searchParams.get('reviewed') ?? '0', 10);
const correct = parseInt(url.searchParams.get('correct') ?? '0', 10);
const streak = parseInt(url.searchParams.get('streak') ?? '0', 10);

// Optional list context
const listIdParam = url.searchParams.get('listId');
const listId = listIdParam ? parseInt(listIdParam, 10) : null;
const list = listId ? getListById(listId, userId) : null;

const dueWords = listId
  ? getDueWordsForList(userId, listId, 20)
  : getDueWords(userId, 20);

const totalCards = dueWords.length;
const currentWord = dueWords[cardIndex];
---

<Head title="VocabUp ‚Äî Study Session" />
    <!-- Nav -->
    <Nav/>

    <main class="max-w-2xl mx-auto px-6 py-12">
      {done ? (
        <!-- Session Summary -->
        <div class="text-center">
          <div class="text-6xl mb-6">{correct === reviewed ? 'üèÜ' : correct > reviewed / 2 ? 'üéØ' : 'üìö'}</div>
          <h1 class="text-3xl font-bold text-gray-900 mb-2">Session Complete!</h1>
          <p class="text-gray-500 mb-8">Great work ‚Äî keep up the momentum.</p>

          <div class="grid grid-cols-3 gap-4 mb-8">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
              <div class="text-3xl font-bold text-indigo-600">{reviewed}</div>
              <div class="text-sm text-gray-500 mt-1">Reviewed</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
              <div class="text-3xl font-bold text-green-600">{reviewed > 0 ? Math.round((correct / reviewed) * 100) : 0}%</div>
              <div class="text-sm text-gray-500 mt-1">Accuracy</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
              <div class="text-3xl font-bold text-orange-500">{streak}</div>
              <div class="text-sm text-gray-500 mt-1">Day Streak</div>
            </div>
          </div>

          <div class="flex gap-4 justify-center flex-wrap">
            {list && (
              <a
                href={`/lists/${list.id}`}
                class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold px-6 py-3 rounded-xl transition-colors"
              >
                ‚Üê Back to List
              </a>
            )}
            <a
              href="/"
              class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-3 rounded-xl transition-colors"
            >
              Back to Dashboard
            </a>
            <a
              href="/words"
              class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold px-6 py-3 rounded-xl transition-colors"
            >
              Browse Words
            </a>
          </div>
        </div>
      ) : totalCards === 0 ? (
        <!-- No cards due -->
        <div class="text-center">
          <div class="text-6xl mb-6">‚úÖ</div>
          <h1 class="text-3xl font-bold text-gray-900 mb-2">Nothing due!</h1>
          {list ? (
            <p class="text-gray-500 mb-8">No words due from <strong>{list.name}</strong>. Add words to the queue or check back tomorrow.</p>
          ) : (
            <p class="text-gray-500 mb-8">You're all caught up. Check back tomorrow for more reviews.</p>
          )}
          <div class="flex gap-4 justify-center flex-wrap">
            {list && (
              <a href={`/lists/${list.id}`} class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold px-6 py-3 rounded-xl transition-colors">
                ‚Üê Back to List
              </a>
            )}
            <a href="/" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-3 rounded-xl transition-colors">
              Back to Dashboard
            </a>
          </div>
        </div>
      ) : currentWord ? (
        <!-- Flashcard -->
        <>
          <h1 class="text-2xl font-bold text-gray-800 mb-1 text-center">Study Session</h1>
          {list && (
            <p class="text-center text-sm text-indigo-500 mb-6">
              <a href={`/lists/${list.id}`} class="hover:underline">‚Üê {list.name}</a>
            </p>
          )}
          {!list && <div class="mb-6"></div>}
          <Flashcard
            wordId={currentWord.id}
            progressId={currentWord.progress_id!}
            word={currentWord.word}
            partOfSpeech={currentWord.part_of_speech}
            definition={currentWord.definition}
            example={currentWord.example}
            cardIndex={cardIndex}
            totalCards={totalCards}
            listId={listId}
          />
        </>
      ) : (
        <!-- Fallback: index out of range -->
        <div class="text-center">
          <p class="text-gray-500">Something went wrong. <a href="/study" class="text-indigo-600 underline">Start over</a>.</p>
        </div>
      )}
    </main>
<Foot />
